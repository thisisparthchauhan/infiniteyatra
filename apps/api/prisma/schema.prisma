generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LegacyRole {
  CUSTOMER
  ADMIN
  OPS
  GUIDE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
  FAILED
}

enum BookingSource {
  DIRECT
  INFLUENCER
  REFERRAL
  OTA
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      LegacyRole     @default(CUSTOMER)
  ltv       Decimal  @default(0) // Lifetime Value
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  profile   Profile?
  bookings  Booking[]
  
  staffProfile StaffProfile?
  assignments  Assignment[]
  loggedIncidents Incident[] @relation("LoggedIncidents")
  userRoles    UserRole[] // RBAC
  accessLogs   AccessLog[]
  
  hotelBookings HotelBooking[]
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // SUPER_ADMIN, FINANCE_MANAGER
  description String?
  userRoles   UserRole[]
  permissions Permission[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Permission {
  id          String   @id @default(uuid())
  action      String   @unique // finance:view, content:edit
  description String?
  roles       Role[]
  createdAt   DateTime @default(now())
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  roleId     String
  role       Role     @relation(fields: [roleId], references: [id])
  assignedAt DateTime @default(now())
  
  @@unique([userId, roleId])
}

model AccessLog {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  action      String   // READ, CREATE, DELETE
  resource    String   // /api/finance/stats
  ip          String?
  userAgent   String?
  granted     Boolean
  createdAt   DateTime @default(now())
}

model Profile {
  id        String  @id @default(uuid())
  userId    String  @unique
  user      User    @relation(fields: [userId], references: [id])
  firstName String
  lastName  String
  phone     String?
}

model Package {
  id           String      @id @default(uuid())
  slug         String      @unique
  title        String
  description  String
  basePrice    Decimal
  costPerSeat  Decimal     @default(0) // Estimated base cost per seat
  durationDays Int
  type         String // TOUR, EXPERIENCE, SPACE
  departures   Departure[]
  mediaGallery String[]    @default([])
  itinerary    Json?
  
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  
  // Orchestration Fields
  version      Int         @default(1)
  requirements Json?       // Ops requirements: { guides: 2, permits: true }
  costStructure Json?      // Base cost breakdown
  healthScore  Decimal     @default(100)
}

model Departure {
  id             String    @id @default(uuid())
  packageId      String
  package        Package   @relation(fields: [packageId], references: [id])
  startDate      DateTime
  endDate        DateTime
  totalSeats     Int
  availableSeats Int
  costOverride   Decimal?  // Specific cost for this trip date
  priceOverride  Decimal?  // Dynamic price for this trip
  vehicleId      String?
  vehicle        Vehicle?  @relation(fields: [vehicleId], references: [id])
  guideId        String?
  bookings       Booking[]
  pricingDecisions PricingDecision[]
  pricingSnapshots PricingSnapshot[]
  inventoryLogs    InventoryLog[]
  tripCosts        TripCost[]
  profitSnapshots  ProfitSnapshot[]
  demandSignals    DemandSignal[]
  forecastSnapshots ForecastSnapshot[]
  automationState  AutomationState?
  pricingGuardrail PricingGuardrail?
  priceAdjustmentLogs PriceAdjustmentLog[]
  
  assignments      Assignment[]
  incidents        Incident[]
  
  // Computed Status
  healthScore      Decimal   @default(100)
  opsStatus        String    @default("PENDING") // PENDING, READY, AT_RISK
  
  readinessChecklist ReadinessChecklist?
}

model CostCategory {
  id          String     @id @default(uuid())
  slug        String     @unique // fuel, permit, guide, vehicle, food
  name        String
  description String?
  type        String     // FIXED, VARIABLE, ONE_TIME
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  tripCosts   TripCost[]
}

model TripCost {
  id             String       @id @default(uuid())
  departureId    String
  departure      Departure    @relation(fields: [departureId], references: [id])
  categoryId     String
  category       CostCategory @relation(fields: [categoryId], references: [id])
  description    String?
  amount         Decimal
  type           String       // FIXED, VARIABLE, PER_PERSON
  currency       String       @default("INR")
  isEstimated    Boolean      @default(false)
  
  // For Variable Costs
  perUnitAmount  Decimal?     // If type is PER_PERSON, this is the cost per person
  quantity       Int?         // E.g. number of litres, or number of people if override

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model FinancialEvent {
  id          String        @id @default(uuid())
  type        String        // BOOKING_CONFIRMED, PAYMENT_RECEIVED, COST_ALLOCATED, REFUND_ISSUED
  referenceId String        // BookingID, TripCostID, TransactionID
  amount      Decimal
  currency    String        @default("INR")
  metadata    Json?
  ledgerEntries LedgerEntry[]
  createdAt   DateTime      @default(now())
}

model DemandSignal {
  id              String   @id @default(uuid())
  departureId     String
  departure       Departure @relation(fields: [departureId], references: [id])
  
  date            DateTime @default(now()) // The date this signal was captured
  daysToDeparture Int
  bookedSeats     Int
  totalSeats      Int
  price           Decimal
  bookingVelocity Decimal  // e.g., bookings in last 24h
  
  metadata        Json?    // Extra signals: holiday, weather, competitor_price
  createdAt       DateTime @default(now())

  @@unique([departureId, date])
}

model ForecastSnapshot {
  id              String    @id @default(uuid())
  departureId     String
  departure       Departure @relation(fields: [departureId], references: [id])
  
  targetDate      DateTime  // When is this forecast for? (Usually departure date)
  predictedDemand Int
  confidenceScore Decimal   // 0.0 to 1.0
  riskLevel       String    // LOW, MEDIUM, HIGH, OVERSOLD
  
  algorithm       String    // "MOVING_AVG", "LINEAR_REGRESSION", "PROPHET"
  modelVersion    String?
  
  createdAt       DateTime  @default(now())
}

model AutomationState {
  id              String    @id @default(uuid())
  departureId     String    @unique
  departure       Departure @relation(fields: [departureId], references: [id])
  
  mode            String    @default("OFF") // OFF, ADVISORY, AUTO
  lastCheck       DateTime?
  lastChange      DateTime?
  
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model PricingGuardrail {
  id              String    @id @default(uuid())
  departureId     String    @unique
  departure       Departure @relation(fields: [departureId], references: [id])
  
  minPrice        Decimal
  maxPrice        Decimal
  maxChangePercent Decimal  @default(5.0) // +/- 5% per cycle
  minMargin       Decimal   @default(10.0) // 10% margin floor
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model PriceAdjustmentLog {
  id              String    @id @default(uuid())
  departureId     String
  departure       Departure @relation(fields: [departureId], references: [id])
  
  oldPrice        Decimal
  newPrice        Decimal
  changePercent   Decimal
  
  trigger         String    // "FORECAST_HIGH_DEMAND", "LOW_UTILIZATION"
  action          String    // "INCREASE", "DECREASE", "HOLD"
  confidence      Decimal
  
  isApplied       Boolean   @default(false) // Driven by mode (AUTO=true, ADVISORY=false)
  
  createdAt       DateTime  @default(now())
}

model ModelRegistry {
  id          String   @id @default(uuid())
  name        String   // e.g. "BasicTrendV1"
  type        String   // REGRESSION, TIME_SERIES
  version     String
  isActive    Boolean  @default(false)
  parameters  Json?
  createdAt   DateTime @default(now())
}

model LedgerEntry {
  id               String         @id @default(uuid())
  eventId          String
  event            FinancialEvent @relation(fields: [eventId], references: [id])
  account          String         // ASSET:CASH, LIABILITY:UNEARNED_REV, REVENUE:SALES, EXPENSE:COGS
  debit            Decimal        @default(0)
  credit           Decimal        @default(0)
  description      String?
  createdAt        DateTime       @default(now())
}

model DiscrepancyLog {
  id          String    @id @default(uuid())
  entityType  String    // BOOKING, PAYMENT
  entityId    String
  expected    Decimal
  actual      Decimal
  reason      String
  status      String    @default("OPEN") // OPEN, RESOLVED, IGNORED
  createdAt   DateTime  @default(now())
  resolvedAt  DateTime?
}

model InvestorMetric {
  id          String   @id @default(uuid())
  key         String   @unique // GMV, REVENUE, CAC, LTV
  name        String
  category    String   // GROWTH, UNIT_ECON, OPS
  valueType   String   // CURRENCY, PERCENT, NUMBER
  
  targetValue Decimal?
  currentValue Decimal
  
  updatedAt   DateTime @updatedAt
}

model GrowthSnapshot {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  
  // Core Metrics
  totalRevenue   Decimal
  totalBookings  Int
  activeUsers    Int
  burnRate       Decimal
  runwayMonths   Decimal
  
  // Unit Economics
  cac            Decimal
  ltv            Decimal
  
  metadata       Json? // Extra breakdowns
  
  createdAt      DateTime @default(now())
}

model NarrativeBlock {
  id          String   @id @default(uuid())
  key         String   // GROWTH_STORY, OPS_WIN, RISK_FACTOR
  title       String
  content     String   // "Revenue grew 15% due to..."
  sentiment   String   // POSITIVE, NEUTRAL, CAUTION
  
  generatedAt DateTime @default(now())
  isPinned    Boolean  @default(false)
}

model StaffProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  certifications  Json?    // e.g. ["First Aid", "Mountaineering"]
  skills          String[]
  experienceYears Int      @default(0)
  emergencyContact Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Assignment {
  id              String    @id @default(uuid())
  departureId     String
  departure       Departure @relation(fields: [departureId], references: [id])
  
  // Resource (Mutually exclusive ideally)
  userId          String?
  user            User?     @relation(fields: [userId], references: [id])
  
  vehicleId       String?
  vehicle         Vehicle?  @relation(fields: [vehicleId], references: [id])
  
  role            String    // GUIDE, DRIVER, VEHICLE, LEAD_GUIDE
  status          String    // ASSIGNED, CONFIRMED, CANCELLED
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model ReadinessChecklist {
  id              String    @id @default(uuid())
  departureId     String    @unique
  departure       Departure @relation(fields: [departureId], references: [id])
  
  status          String    // PLANNING, READY, AT_RISK, COMPLETED
  items           Json      // { "guides": true, "permits": false }
  
  updatedAt       DateTime  @updatedAt
}

model Incident {
  id              String    @id @default(uuid())
  departureId     String?
  departure       Departure? @relation(fields: [departureId], references: [id])
  
  severity        String    // INFO, WARNING, CRITICAL
  title           String
  description     String
  status          String    // OPEN, RESOLVED
  loggedById      String
  loggedBy        User      @relation("LoggedIncidents", fields: [loggedById], references: [id])
  
  createdAt       DateTime  @default(now())
  resolvedAt      DateTime?
}

model ProfitSnapshot {
  id             String       @id @default(uuid())
  departureId    String
  departure      Departure    @relation(fields: [departureId], references: [id])
  
  totalRevenue   Decimal
  totalCost      Decimal
  grossProfit    Decimal
  marginPercent  Decimal
  
  breakEvenPrice Decimal      // (Fixed Costs / Total Seats) + Variable Cost Per Seat
  
  occupancyRate  Decimal
  snapshotDate   DateTime     @default(now())
}

model Vehicle {
  id          String      @id @default(uuid())
  name        String      // e.g. "Force Traveler 12-Seater"
  type        String      // BUS, FLIGHT, TRAIN, SPACECRAFT
  capacity    Int
  plateNumber String?
  status      String      @default("ACTIVE") // ACTIVE, MAINTENANCE
  departures  Departure[]
  assignments Assignment[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model InventoryLog {
  id          String    @id @default(uuid())
  departureId String
  departure   Departure @relation(fields: [departureId], references: [id])
  action      String    // RESERVE, RELEASE, BOOK, BLOCK
  seats       Int       // Positive or negative change
  reason      String?
  referenceId String?   // Booking ID or Transaction ID
  createdAt   DateTime  @default(now())
}

model PricingRule {
  id          String   @id @default(uuid())
  name        String
  description String?
  condition   Json     // e.g. { "utilization": { "gt": 80 }, "daysToDeparture": { "lt": 7 } }
  action      Json     // e.g. { "type": "MULTIPLY", "value": 1.10 }
  priority    Int      @default(0)
  isActive    Boolean  @default(true)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  decisions   PricingDecision[]
}

model PricingDecision {
  id            String      @id @default(uuid())
  departureId   String
  departure     Departure   @relation(fields: [departureId], references: [id])
  ruleId        String?
  rule          PricingRule? @relation(fields: [ruleId], references: [id])
  originalPrice Decimal
  newPrice      Decimal
  reason        String
  confidence    Decimal     @default(1.0)
  applied       Boolean     @default(false) // Admin approval status
  snapshotId    String      @unique
  snapshot      PricingSnapshot @relation(fields: [snapshotId], references: [id])
  createdAt     DateTime    @default(now())
}

model PricingSnapshot {
  id              String   @id @default(uuid())
  departureId     String
  departure       Departure @relation(fields: [departureId], references: [id])
  decision        PricingDecision?
  
  // Feature Vector for ML
  bookedSeats     Int
  totalSeats      Int
  daysToDeparture Int
  bookingVelocity Decimal  // Bookings per day (avg)
  currentPrice    Decimal
  
  createdAt       DateTime @default(now())
}


model Booking {
  id            String        @id @default(uuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  departureId   String
  departure     Departure     @relation(fields: [departureId], references: [id])
  status        BookingStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  source        BookingSource @default(DIRECT)
  
  seatsBooked   Int           @default(1)
  totalAmount   Decimal
  amountPaid    Decimal       @default(0)
  
  transactions  Transaction[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Transaction {
  id          String   @id @default(uuid())
  bookingId   String
  booking     Booking  @relation(fields: [bookingId], references: [id])
  amount      Decimal
  type        String   // PAYMENT, REFUND
  status      String   // SUCCESS, FAILED, PENDING
  reference   String?  // Gateway ID
  createdAt   DateTime @default(now())
}




// --- IY HOTELS VERTICAL ---

model Hotel {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String
  city        String
  address     String
  rating      Decimal  @default(0) // 0-5 stars
  amenities   String[] // Pool, WiFi, Gym
  images      String[]
  
  partnerId   String?  // Future: Link to Hotel Partner User
  
  rooms       RoomType[]
  bookings    HotelBooking[]
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RoomType {
  id          String   @id @default(uuid())
  hotelId     String
  hotel       Hotel    @relation(fields: [hotelId], references: [id])
  
  name        String   // e.g. "Deluxe Ocean View"
  description String?
  basePrice   Decimal
  capacity    Int      // Max guests
  amenities   String[]
  images      String[]
  
  availabilities HotelAvailability[]
  bookingItems   HotelBookingItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model HotelAvailability {
  id          String   @id @default(uuid())
  roomTypeId  String
  roomType    RoomType @relation(fields: [roomTypeId], references: [id])
  
  date        DateTime
  totalRooms  Int
  bookedRooms Int      @default(0)
  priceOverride Decimal? // Dynamic pricing for this date
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([roomTypeId, date])
}

model HotelBooking {
  id            String        @id @default(uuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  
  hotelId       String
  hotel         Hotel         @relation(fields: [hotelId], references: [id])
  
  checkIn       DateTime
  checkOut      DateTime
  guests        Int
  
  totalAmount   Decimal
  status        BookingStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  
  items         HotelBookingItem[]
  
  source        BookingSource @default(DIRECT)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model HotelBookingItem {
  id             String       @id @default(uuid())
  bookingId      String
  booking        HotelBooking @relation(fields: [bookingId], references: [id])
  roomTypeId     String
  roomType       RoomType     @relation(fields: [roomTypeId], references: [id])
  
  quantity       Int          @default(1)
  pricePerNight  Decimal
  totalPrice     Decimal
}
